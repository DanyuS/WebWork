var mysql=require('mysql');

function connectServer(){

    var client=mysql.createConnection({
        host:'127.0.0.1',
        user:'root',
        password:'123456',
        database:'node'
    })

    console.log("-------------------数据库连接成功");
    return client;
}


function  selectFun(client,username,callback){
    //client为一个mysql连接对象
    client.query('select password from user where user="'+username+'"',function(err,results,fields){
        if(err) throw err;

        callback(results);
    });
}

function insertFun(client , username , password,callback){
    client.query('insert into user(user,password) value(?,?)', [username, password], function(err,result){
        if( err ){
            console.log( "error:" + err.message);
            return err;
        }
          callback(err);
    });
}

//加入图片
function addPicture(client ,pictureAddr,time,callback){
    client.query('insert into picturelabel(pictureAddr,time) value (?,?)', [pictureAddr, time], function(err,result){
        console.log("------------------进入添加图片"+pictureAddr);
        if( err ){
            console.log( "error:" + err.message);
            return err;
        }
        callback(err);
    });
}

//查询标签数量
function  findPictureLabelNum(client,pid,labels,callback){
    //client为一个mysql连接对象
    client.query('select * from picturelabel where pid="'+pid+'" and label="'+labels+'"',function(err,results,fields){
        console.log("------------------进入查询标签"+labels);

        if(err) throw err;

        if(results){
            for(var i = 0; i < results.length; i++)

            {
                console.log("---------------------------------该标签数量:"+results[i].labelNum);
            }
            //console.log("---------------------------------该标签数量");
        }
        callback(results);
    });
}


//查询标签
function  findPictureLabel(client,pid,callback){
    //client为一个mysql连接对象
    client.query('select * from picturelabel where pid="'+pid+'"',function(err,results,fields){
        console.log("------------------进入查询所有标签"+pid);

        if(err) throw err;

        if(results){
            for(var i = 0; i < results.length; i++)

            {
                console.log("---------------------------------该图片标签:"+results[i].label);
            }
            //console.log("---------------------------------该标签数量");
        }
        callback(results);
    });
}

//加入标签及数量
function insertLabel(client ,pid, labels,numb,callback){
    client.query('insert into picturelabel(pid,label,labelNum) value (?,?,?)', [pid, labels,numb], function(err,result){
        console.log("------------------进入添加标签"+labels);
        if( err ){
            console.log( "error:" + err.message);
            return err;
        }
        callback(err);
    });
}
//修改标签及数量
function modifyLabel(client ,pid, labels,numb,callback){
    //UPDATE account SET password=? WHERE name=? AND password=?
    client.query('UPDATE picturelabel SET labelNum=? WHERE pid=? AND label=?', [numb,pid, labels], function(err,result){
        console.log("------------------进入添加标签"+labels);
        if( err ){
            console.log( "error:" + err.message);
            return err;
        }
        callback(err);
    });
}
//查询具体图片
function searchPicture(client ,pid,callback){
    client.query('select * from pictureinfo where pictureAddr="'+pid+'"', function(err,results){
        console.log("------------------进入查询图片"+pid);

        if( err ){
            console.log( "error:" + err.message);
            return err;
        }
        callback(results);
    });
}
//修改访问量
function modifyView(client ,pid,numb,callback){
    client.query('UPDATE pictureinfo SET pageview=? WHERE pictureAddr=?', [numb,pid], function(err,result){
        console.log("------------------进入修改访问量"+pid+numb);
        if( err ){
            console.log( "error:" + err.message);
            return err;
        }
        callback(err);
    });
}
//修改标签量
function modifylabelNum(client ,pid,numb,callback){
    client.query('UPDATE pictureinfo SET labelnumber=? WHERE pictureAddr=?', [numb,pid], function(err,result){
        console.log("------------------进入修改标签数量"+pid+numb);
        if( err ){
            console.log( "error:" + err.message);
            return err;
        }
        callback(err);
    });
}
//以访问量展示图片
function showPictureByView(client ,callback){
    client.query('select * from pictureinfo order by pageview DESC', function(err,results){
        console.log("------------------进入访问量降序展示图片");

        if( err ){
            console.log( "error:" + err.message);
            return err;
        }
        callback(results);
    });
}
//以标签数量展示图片
function showPictureByLabel(client ,callback){
    client.query('select * from pictureinfo order by labelnumber DESC', function(err,results){
        console.log("------------------进入标签数量降序展示图片");

        if( err ){
            console.log( "error:" + err.message);
            return err;
        }
        callback(results);
    });
}
//以添加时间展示图片
function showPictureByTime(client ,callback){
    client.query('select * from pictureinfo order by time DESC', function(err,results){
        console.log("------------------进入添加时间降序展示图片");

        if( err ){
            console.log( "error:" + err.message);
            return err;
        }
        callback(results);
    });
}
exports.connect = connectServer;
exports.selectFun  = selectFun;
exports.insertFun = insertFun;

exports.addPicture = addPicture;

exports.insertLabel = insertLabel;
exports.modifyLabel = modifyLabel;
exports.findPictureLabelNum = findPictureLabelNum;
exports.findPictureLabel = findPictureLabel;

exports.searchPicture = searchPicture;
exports.modifyView = modifyView;
exports.modifylabelNum = modifylabelNum;
exports.showPictureByView = showPictureByView;
exports.showPictureByLabel = showPictureByLabel;
exports.showPictureByTime = showPictureByTime;

